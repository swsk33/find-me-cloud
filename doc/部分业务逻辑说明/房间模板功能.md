## 1，什么是模板房间？

在之前版本的FindMe中，要想共享位置，用户的流程通常如下：

1. 创建房间并设定房间名和密码
2. 把房间信息发给朋友
3. 朋友复制房间`id`和密码加入房间

但是对于经常需要位置共享的用户来说，每次都要创建房间，然后分享、加入房间，这是非常麻烦的。

而模板房间功能，允许用户在自己的账户数据中预先存放一个**房间模板**，并且可以将这个模板分享给其他用户，使得其他用户也能够把这个模板加入到自己的用户数据中。

然后如果需要进行共享位置，多个用户只需加入同一个房间模板，就能够实现直接加入同一个房间，而无需临时创建分享房间。

房间模板功能，简化了位置共享的前置操作，使得用户更加专注于位置共享。

一个房间模板的数据结构如下：

![image-20230726111215485](https://swsk33-note.oss-cn-shanghai.aliyuncs.com/undefinedundefinedimage-20230726111215485.png)

上述：

- `id` 模板`id`，当使用模板加入房间时，会首先创建一个普通房间，其`id`和这个模板`id`一致，然后加入
- `name` 模板房间名
- `masterId` 房间模板的创建者的`id`，可以视为这个模板房间的房主，只有创建者才能够删除这个模板
- `userIdList` 拥有这个模板的用户`id`列表，只有包含在这个列表中的用户才能使用这个房间模板

## 2，房间模板功能的主要逻辑

房间模板功能简化房间操作的核心，就是预先存放一个`id`和房间名，要使用时通过创建一个`id`和名字和这个模板一致的房间并加入，并且后来者可以直接加入，而不是临时创建。

假设现在有用户A、用户B拥有同一个模板，其`id`为`1`，`name`为`abc`（这里只是举例，实际业务中`id`是`UUID`的形式），这时两者都需要通过这个房间模板进行位置共享，那么这个情景的细节和背后的操作可以总结如下：

- 用户A率先点击加入这个模板，这时**后端**接收到请求，首先去查询Redis中是否存在`id`为`1`的普通房间，**房间不存在**，则系统先自动依据这个模板，创建`id`为`1`、`name`为`abc`的普通房间
- 与此同时，用户A需要发送**认证信息**，这个工作由**前端**完成，这里的认证消息和普通房间认证不同，认证流程将在下面详细说明
- 认证完成后，用户A就加入了房间
- 这时，用户B也通过该房间模板加入，**后端**接收到请求，去Redis中查询`id`为`1`的普通房间，由于A已经先加入房间，房间已经被系统自动创建了，因此B就直接被加入房间，不过，B也需要发送认证消息，认证成功后B也完成了加入房间

## 3，认证流程

在普通房间的认证中，用户是先通过WebSocket连接到房间，然后由前端发送认证消息，认证成功才会继续允许用户分享位置。

而使用模板房间的认证流程也是相同的，只不过发送的认证消息不同。

先开始连接时，和普通房间一样，对路径`/ws/session/room/{roomId}/{userId}`发起WebSocket连接，这时会话属于未认证状态，然后前端会发送认证消息如下：

```json
{
	"type": "TEMPLATE_AUTH"
}
```

然后，后端会根据`type`字段，使用**策略模式**处理这一条消息，将这个消息传入到模板认证策略中进行认证，认证流程如下：

- 提取路径的`roomId`，去MongoDB取得为这个`id`的模板对象
- 提取路径的`userId`，查看其是否包含在上述取得的模板对象的`userIdList`中，包含则认证成功，直接加入房间（房间不存在会先创建）
- 若认证失败，则会被强制断开连接
- 认证超时等其它异常情况，处理方式和连接普通房间认证时相同

## 4，模板分享

当一个用户创建了模板后，就可以把这个模板分享给其他用户，让其他用户也加入到他们的模板列表中。

模板分享通过生成**分享密钥**的形式完成，步骤如下：

- 一个用户点击分享房间模板按钮，后端生成一个分享密钥，有效期`24`小时（存放在Redis并设置过期时间），并将分享密钥发送给别的用户
- 另外的用户接收到分享密钥，填写到添加模板的输入框并通过请求传递给后端
- 后端校验密钥，若未过期，则从当前登录Session中取出添加模板的用户，并将这个用户`id`加入该模板的用户`id`列表中，与此同时这个模板信息也会被存入该用户模板列表

一个模板分享信息数据结构如下：

![image-20230725225323218](https://swsk33-note.oss-cn-shanghai.aliyuncs.com/undefinedimage-20230725225323218.png)

上述：

- `id` 表示分享信息的`id`，也就是上述提到的**分享密钥**
- `templateId` 表示分享信息对应的模板`id`